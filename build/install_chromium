#!/bin/bash

# This script will install chromium to use with the browser block
# If the device is a Raspberry Pi (any model), it will use the version
# from the raspios repo (together with mesa and X), because
# * Since Debian 12, the upstream chromium provided in Debian repos
#   does not work on armv7 at all
# * The upstream chromium will not work on devices with < 1GB memory
#   namely the Pi3A and the PiZero2 even when using aarch64
# * The Raspberry Pi 5 needs patched versions of mesa and X to work

BASE_DIR="/usr/src/build"
CHROMIUM_PACKAGE="chromium"

MACHINE_NAME="$1"

# FORCE_RPI_REPO=0 never includes the repo
# FORCE_RPI_REPO=1 always includes the repo
# If the machine name starts with "raspberry", or if the machine
# is a balenaFin, include the repo
if [ "${FORCE_RPI_REPO}" != "0" ] && [ "${FORCE_RPI_REPO}" = "1" -o "${MACHINE_NAME:0:9}" = "raspberry" -o "${MACHINE_NAME}" = "fincm3" ]
then
    echo "Enabling raspios repository"

    cp -a "${BASE_DIR}/rpi/raspi.list" "/etc/apt/sources.list.d/"
    cp -a "${BASE_DIR}/rpi/raspberrypi-archive-stable.gpg" "/etc/apt/trusted.gpg.d/"
fi

# mimic previous balenalib "install_packages" behavior:
apt-get update && apt-get install -y  --no-install-recommends \
    ${CHROMIUM_PACKAGE} \
    chromium-common \
    lsb-release \
    mesa-vdpau-drivers \
    grim \
    fonts-noto \
    fonts-noto-color-emoji \
    cage \
    mpv \
    seatd \
    udev \
    initscripts \
    jq \
    kanshi && \
    rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/*
